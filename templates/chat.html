{% extends "base.html" %}

{% block title %}{{ recipient }} ile Sohbet - ChatNell{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h2 style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; font-size: 1.8rem;">
                üí¨ {{ recipient }} ile Sohbet
            </h2>
            <div id="user-status" style="font-size: 12px; padding: 4px 8px; border-radius: 12px; background: #ecf0f1; color: #7f8c8d;"></div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="search-input" placeholder="üîç Mesaj ara..." 
                   style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 20px; font-size: 12px; width: 150px;">
            <a href="{{ url_for('dashboard') }}" class="btn">‚Üê Geri D√∂n</a>
        </div>
    </div>

    <div id="search-results" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 10px; max-height: 150px; overflow-y: auto;"></div>

    <div id="messages-container" style="height: 450px; overflow-y: auto; border: 2px solid #eee; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, #f8f9fa, #ffffff);">
        <div id="messages"></div>
    </div>

    <div id="message-input-container" style="display: flex; gap: 15px; align-items: flex-end; position: relative;">
        <div style="flex: 1;">
            <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <button onclick="insertEmoji('üòÄ')" class="emoji-btn">üòÄ</button>
                <button onclick="insertEmoji('üòç')" class="emoji-btn">üòç</button>
                <button onclick="insertEmoji('üòÇ')" class="emoji-btn">üòÇ</button>
                <button onclick="insertEmoji('ü•∞')" class="emoji-btn">ü•∞</button>
                <button onclick="insertEmoji('üòé')" class="emoji-btn">üòé</button>
                <button onclick="insertEmoji('ü§î')" class="emoji-btn">ü§î</button>
                <button onclick="insertEmoji('üëç')" class="emoji-btn">üëç</button>
                <button onclick="insertEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                <button onclick="insertEmoji('üî•')" class="emoji-btn">üî•</button>
                <button onclick="insertEmoji('‚ú®')" class="emoji-btn">‚ú®</button>
            </div>
            <div class="input-wrapper">
                <textarea id="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." 
                         style="width: 100%; min-height: 60px; max-height: 150px; padding: 20px; border: none; border-radius: 25px; font-size: 15px; resize: none; font-family: inherit; background: #f8f9fa; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; outline: none;"
                         onkeydown="handleKeyDown(event)" oninput="adjustTextareaHeight(this)"></textarea>
                <div id="typing-indicator" class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
        <button id="send-btn" onclick="sendMessage()" class="send-btn" disabled>
            <span class="send-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                </svg>
            </span>
            <span class="loading-spinner" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3" fill="currentColor">
                        <animate attributeName="r" values="3;6;3" dur="1s" repeatCount="indefinite"/>
                        <animate attributeName="opacity" values="1;0.5;1" dur="1s" repeatCount="indefinite"/>
                    </circle>
                </svg>
            </span>
        </button>
    </div>
</div>

<style>
.emoji-btn {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.emoji-btn:hover {
    background: linear-gradient(135deg, #667eea, #764ba2);
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.input-wrapper {
    position: relative;
}

.input-wrapper textarea:focus {
    background: white;
    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
    transform: translateY(-2px);
}

.send-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
}

.send-btn:hover:not(:disabled) {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.send-btn:disabled {
    background: #dee2e6;
    cursor: not-allowed;
    box-shadow: none;
}

.send-btn:active:not(:disabled) {
    transform: translateY(-1px) scale(0.98);
}

.typing-indicator {
    display: none;
    position: absolute;
    bottom: 15px;
    left: 25px;
    color: #6c757d;
    font-size: 14px;
}

.typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
.typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}

.message-sending {
    opacity: 0.7;
    transform: translateX(10px);
    transition: all 0.3s ease;
}

.message-sent {
    animation: messageSent 0.5s ease;
}

.message-item {
    margin-bottom: 15px;
    display: flex;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes messageSuccess {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); background: rgba(40, 167, 69, 0.1); }
    100% { transform: scale(1); }
}

@keyframes messageError {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); background: rgba(220, 53, 69, 0.1); }
    75% { transform: translateX(5px); }
    100% { transform: translateX(0); }
}

@keyframes messageSent {
    0% { opacity: 0.7; transform: translateX(10px); }
    100% { opacity: 1; transform: translateX(0); }
}

.message-actions {
    opacity: 0;
    transition: opacity 0.2s;
    margin-left: 10px;
}

.message-item:hover .message-actions {
    opacity: 1;
}

.delete-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    cursor: pointer;
}

.search-result {
    padding: 8px;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    transition: background 0.2s;
}

.search-result:hover {
    background: #e9ecef;
}

.typing-indicator {
    display: none;
    color: #666;
    font-style: italic;
    font-size: 12px;
    margin: 10px 0;
}
</style>

<script>
const recipient = '{{ recipient }}';
const currentUser = '{{ session.username }}';
let lastMessageCount = 0;

function updateUserStatus() {
    fetch(`/get_user_status/${recipient}`)
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('user-status');
            const statusText = data.status === 'online' ? 'üü¢ √áevrimi√ßi' : 
                             data.status === 'away' ? 'üü° Uzakta' : 'üî¥ √áevrimdƒ±≈üƒ±';
            statusEl.textContent = statusText;
            statusEl.style.background = data.status === 'online' ? '#d4edda' : 
                                      data.status === 'away' ? '#fff3cd' : '#f8d7da';
        });
}

function insertEmoji(emoji) {
    const messageInput = document.getElementById('message-input');
    const start = messageInput.selectionStart;
    const end = messageInput.selectionEnd;
    const text = messageInput.value;

    messageInput.value = text.substring(0, start) + emoji + text.substring(end);
    messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
    messageInput.focus();
}

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function loadMessages() {
    fetch(`/get_messages/${recipient}`)
        .then(response => response.json())
        .then(messages => {
            const messagesDiv = document.getElementById('messages');
            const container = document.getElementById('messages-container');
            const shouldScroll = container.scrollTop + container.clientHeight >= container.scrollHeight - 20;

            messagesDiv.innerHTML = '';

            messages.forEach(msg => {
                if (msg.deleted) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-item';
                const isOwn = msg.sender === currentUser;

                messageDiv.style.cssText = `
                    justify-content: ${isOwn ? 'flex-end' : 'flex-start'};
                `;

                const messageContent = document.createElement('div');
                messageContent.style.cssText = `
                    max-width: 70%;
                    padding: 15px 20px;
                    border-radius: 20px;
                    word-wrap: break-word;
                    position: relative;
                    ${isOwn ? 
                        'background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-bottom-right-radius: 6px;' : 
                        'background: white; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);'
                    }
                `;

                const time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageContent.innerHTML = `
                    <div style="font-weight: 600; font-size: 12px; margin-bottom: 5px; opacity: 0.8;">
                        ${isOwn ? 'Sen' : msg.sender}
                    </div>
                    <div style="margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;">${msg.message}</div>
                    <div style="font-size: 11px; opacity: 0.7; text-align: right;">${time}</div>
                `;

                messageDiv.appendChild(messageContent);

                if (isOwn) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    actionsDiv.innerHTML = `
                        <button class="delete-btn" onclick="deleteMessage(${msg.id})">üóëÔ∏è</button>
                    `;
                    messageDiv.appendChild(actionsDiv);
                }

                messagesDiv.appendChild(messageDiv);
            });

            if (shouldScroll || messages.length !== lastMessageCount) {
                container.scrollTop = container.scrollHeight;
            }
            lastMessageCount = messages.length;
        })
        .catch(error => console.error('Error loading messages:', error));
}

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const message = messageInput.value.trim();

    if (!message) return;

    // G√∂nderme animasyonu ba≈ülat
    showSendingAnimation();
    sendBtn.disabled = true;
    
    // Ge√ßici mesaj ekle
    addTemporaryMessage(message);

    fetch('/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            recipient: recipient,
            message: message 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            adjustTextareaHeight(messageInput);
            removeTemporaryMessage();
            loadMessages();
            showSuccessAnimation();
        } else {
            removeTemporaryMessage();
            showErrorAnimation();
            alert('Mesaj g√∂nderilemedi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        removeTemporaryMessage();
        showErrorAnimation();
        alert('Mesaj g√∂nderilirken hata olu≈ütu');
    })
    .finally(() => {
        hideSendingAnimation();
        sendBtn.disabled = false;
    });
}

function showSendingAnimation() {
    const sendBtn = document.getElementById('send-btn');
    const sendIcon = sendBtn.querySelector('.send-icon');
    const loadingSpinner = sendBtn.querySelector('.loading-spinner');
    
    sendIcon.style.display = 'none';
    loadingSpinner.style.display = 'flex';
    sendBtn.style.transform = 'scale(0.95)';
}

function hideSendingAnimation() {
    const sendBtn = document.getElementById('send-btn');
    const sendIcon = sendBtn.querySelector('.send-icon');
    const loadingSpinner = sendBtn.querySelector('.loading-spinner');
    
    sendIcon.style.display = 'flex';
    loadingSpinner.style.display = 'none';
    sendBtn.style.transform = 'scale(1)';
}

function showSuccessAnimation() {
    const inputContainer = document.getElementById('message-input-container');
    inputContainer.style.animation = 'messageSuccess 0.5s ease';
    setTimeout(() => {
        inputContainer.style.animation = '';
    }, 500);
}

function showErrorAnimation() {
    const inputContainer = document.getElementById('message-input-container');
    inputContainer.style.animation = 'messageError 0.5s ease';
    setTimeout(() => {
        inputContainer.style.animation = '';
    }, 500);
}

function addTemporaryMessage(message) {
    const messagesDiv = document.getElementById('messages');
    const container = document.getElementById('messages-container');
    
    const tempMessageDiv = document.createElement('div');
    tempMessageDiv.id = 'temp-message';
    tempMessageDiv.className = 'message-item message-sending';
    tempMessageDiv.style.justifyContent = 'flex-end';

    const messageContent = document.createElement('div');
    messageContent.style.cssText = `
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 20px;
        word-wrap: break-word;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-bottom-right-radius: 6px;
        opacity: 0.7;
    `;

    messageContent.innerHTML = `
        <div style="font-weight: 600; font-size: 12px; margin-bottom: 5px; opacity: 0.8;">
            Sen
        </div>
        <div style="margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;">${message}</div>
        <div style="font-size: 11px; opacity: 0.7; text-align: right;">G√∂nderiliyor...</div>
    `;

    tempMessageDiv.appendChild(messageContent);
    messagesDiv.appendChild(tempMessageDiv);
    container.scrollTop = container.scrollHeight;
}

function removeTemporaryMessage() {
    const tempMessage = document.getElementById('temp-message');
    if (tempMessage) {
        tempMessage.remove();
    }
}

function adjustTextareaHeight(textarea) {
    const sendBtn = document.getElementById('send-btn');
    textarea.style.height = '60px';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    
    // Send butonunu etkinle≈ütir/devre dƒ±≈üƒ± bƒ±rak
    if (textarea.value.trim()) {
        sendBtn.disabled = false;
        sendBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    } else {
        sendBtn.disabled = true;
        sendBtn.style.background = '#dee2e6';
    }
}

function deleteMessage(messageId) {
    if (!confirm('Bu mesajƒ± silmek istediƒüinizden emin misiniz?')) return;

    fetch('/delete_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message_id: messageId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadMessages();
        } else {
            alert('Mesaj silinemedi: ' + data.error);
        }
    });
}

function searchMessages() {
    const query = document.getElementById('search-input').value.trim();
    const resultsDiv = document.getElementById('search-results');

    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }

    fetch(`/search_messages?q=${encodeURIComponent(query)}&recipient=${recipient}`)
        .then(response => response.json())
        .then(results => {
            if (results.length > 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<strong>üîç Arama Sonu√ßlarƒ±:</strong><br>' +
                    results.map(msg => `
                        <div class="search-result">
                            <strong>${msg.sender}:</strong> ${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}
                            <small style="color: #666; display: block;">${new Date(msg.timestamp).toLocaleString('tr-TR')}</small>
                        </div>
                    `).join('');
            } else {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<em>Sonu√ß bulunamadƒ±</em>';
            }
        });
}

// Auto-resize textarea ve send buton kontrol√º
document.getElementById('message-input').addEventListener('input', function() {
    adjustTextareaHeight(this);
});

// Search functionality
document.getElementById('search-input').addEventListener('input', searchMessages);

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#search-input') && !e.target.closest('#search-results')) {
        document.getElementById('search-results').style.display = 'none';
    }
});

// Load messages on page load
loadMessages();
updateUserStatus();

// Refresh messages and status periodically
setInterval(loadMessages, 3000);
setInterval(updateUserStatus, 10000);

// Focus on input
document.getElementById('message-input').focus();
</script>
{% endblock %}